<!DOCTYPE html>
<html  xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
       layout:decorate="~{Layout}">
    <head>

        <style>

            .container-info p{
                color: var(--text-main);
                font-size: 1.1rem;
                padding: .2rem;
                margin: .125rem;
            }

            .perfil-img{
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
            }

            .btn-link {
                display: inline-block;
                background-color: var(--text-secondary, 1);
                color: #121317;
                padding: 0.5rem 1rem;
                border: none;
                border-radius: 8px;
                text-decoration: none;
                font-weight: 500;
                font-size: 0.875rem;
            }

            .btn-link:hover {
                background-color: var(--accent-secondary);
                color: #fff;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            }

            p{
                color: var(--text-main);
                font-size: 1.1rem;
                padding: .2rem;
                margin: .125rem;
            }

        </style>

    </head>
    <body layout:fragment="body">
        <div class="container mt-3 border border-dark rounded-5">
            <div class="row border border-dark rounded-5">
                <div class="col-3 border border-dark rounded-5">
                    <div class="d-flex flex-column align-items-center h-50">
                        <img class="perfil-img" th:if="${usuario.Imagen == null}" src="https://img.freepik.com/psd-gratis/ilustracion-3d-avatar-o-perfil-humano_23-2150671122.jpg" alt="Perfil de usuario"/>
                        <img class="perfil-img" th:if="${usuario.Imagen != null}" src="data:image/jpeg;base64," th:attrappend="src=${usuario.Imagen}"  alt="Perfil de usuario">
                        <div>
                            <button id="btnEditarImagen"
                                    style="background-color: transparent; border: none; color: inherit; padding: 0; font-size: inherit;">
                                <i class="bi bi-pencil-square" style="color: #E5E5E5; font-size: 1.3rem"></i></button>
                            <i  class="bi bi-trash3" style="color: #E5E5E5; font-size: 1.3rem"></i>
                        </div>
                    </div>

                    <div class="container-info">
                        <p th:text='| ${usuario.Nombre} ${usuario.ApellidoPaterno} ${usuario.ApellidoMaterno}|'></p>
                        <p th:text='${usuario.UserName}' class='fw-bold' ></p>
                        <p th:text="${usuario.Rol.Nombre != null} ? ${usuario.Rol.Nombre}: 'No hay rol asignado'"></p>
                        <button class="btn-link" id="btnEditarInformacion">Editar información</button>
                    </div>
                </div>

                <div class="col-9">
                    <div class="row">
                        <div class="col-12">
                            <div class='container rounded-5'>
                                <p >Datos personales</p>
                                <div class='d-flex justify-content-evenly'>
                                    <div>
                                        <p >Fecha de nacimiento</p>
                                        <p th:text='${usuario.FechaNacimiento}'>29 de Septiembre del 2002</p>
                                    </div>
                                    <div>
                                        <p >Sexo</p>
                                        <p  th:text="${usuario.Sexo=='F'} ? 'Femenino': 'Masculino'" ></p>
                                    </div>
                                    <div>
                                        <p >CURP</p>
                                        <p th:text="${usuario.Curp}"></p>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <div class="col-12 mt-1">
                            <div class='container rounded-5' >
                                <p >Datos de contacto</p>
                                <div class='d-flex justify-content-evenly'>
                                    <div>
                                        <p>Correo Electronico</p>
                                        <p th:text="${usuario.Email}"></p>
                                    </div>
                                    <div>
                                        <p >Telefomo</p>
                                        <p th:text="${usuario.Telefono}"></p>
                                    </div>
                                    <div>
                                        <p >Celular</p>
                                        <p th:text="${usuario.Celular}"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Esto es para actualizar usuario -->
            <div class="container border border-dark rounded-5">
                <!-- Modal para cargar imagen -->
                <div class="modal" id="modalActualizarImagen">
                    <form id="formEditImagen" th:action="@{/UsuarioIndex/updateImage/{idUsuario}(idUsuario=${usuario.IdUsuario})}" method="POST" enctype="multipart/form-data">
                        <input type="file" class="form-control mb-2" name="imagenFile" id="imagenFile" accept="image/*">
                    </form>
                    <div class="modal-footer">
                        <button  onclick="actualizarImagenSubmit()">Enviar</button>
                        <button type="button" class="btn btn-default" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
                <div class="modal fade" id="modalFormulario" role="dialog">
                    <div class="modal-dialog">
                        <!-- Modal content-->
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                <h4 class="modal-title">Modal Header</h4>
                            </div>
                            <form  th:action="@{/UsuarioIndex/update}" id="formUpdateUser" th:object="${usuario}" method="POST" >
                                <input type="hidden" th:field="*{IdUsuario}">
                                <label>Nombre</label>
                                <input type="text"  th:value="${usuario.Nombre}" name="Nombre" th:field="*{Nombre}" >
                                <label>Apellido Paterno</label>
                                <input type="text" th:value="${usuario.ApellidoPaterno}" name="ApellidoPaterno" th:field="*{ApellidoPaterno}" >
                                <label>Apellido Materno</label>
                                <input type="text" th:value="${usuario.ApellidoMaterno}" name="ApellidoMaterno" th:field="*{ApellidoMaterno}" >
                                <label>User Name</label>
                                <input type="text" th:value="${usuario.UserName}" name="UserName" th:field="*{UserName}">
                                <label>CURP</label>
                                <input type="text" th:value="${usuario.Curp}" name="Curp" th:field="*{Curp}" >

                                <label>Rol</label>
                                <select  id="rol" class="form-control" th:value="${usuario.Rol.IdRol}" th:field="*{Rol.IdRol}" name="IdRol">
                                    <option value="0" selected >Seleccione un rol</option>
                                    <option th:each="rol : ${roles}"
                                            th:value="${rol.IdRol}"
                                            th:text="${rol.Nombre}">
                                    </option>
                                </select>
                                <label>Email</label>
                                <input type="text"  name="Email"  th:field="*{Email}"/>
                                <label >Celular</label>
                                <input type="text"  name="Celular"  th:field="*{Celular}"/>
                                <label >Telefono</label>
                                <input type="text" name="Telefono"  th:field="*{Telefono}"/>
                                <label >Fecha de Nacimiento</label>
                                <input type="date"  name="FechaNacimiento" th:field="*{FechaNacimiento}"/>
                                <p th:text="${usuario.Sexo == 'M '}"></p>
                                <input type="radio" id='inputM'  th:field="*{Sexo}" value="M " ><label for="inputM">Masculino</label>
                                <input type="radio"  id='inputF' th:field="*{Sexo}" value="F " ><label for="inputF">Femenino</label>

                            </form>

                            <div class="modal-footer">
                                <button  onclick="form_submit()">Enviar</button>
                                <button type="button" class="btn btn-default" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>  

            <div class="container rounded-5 w-75">

                <div class="row">
                    <p  class='col-6' >Direcciones</p>
                    <div class=" col-6 text-center  ">
                        <a class="m-0  btn btn-primary" id="btnAgregarDireccion">Agregar dirección</a>
                    </div>
                </div>

                <div class="modal fade" id="modalAddDireccion">
                    <div class="modal-dialog">
                        <div class="modal-content">

                            <form method="POST" th:action="@{/UsuarioIndex/addDireccion}" id="formAddDireccion" th:object="${Direccion}">
                                <input type="hidden"  th:value="${usuario.IdUsuario}" name="IdUsuario">
                                <input type="text" th:field="*{Calle}" placeholder="Calle">
                                <input type="text" th:field="*{NumeroInterior}" placeholder="NumeroInterior">
                                <input type="text" th:field="*{NumeroExterior}" placeholder="NumeroExterior">
                                <input type="number" th:field="*{Colonia.IdColonia}" placeholder="IdColonia">
                            </form>

                            <div class="modal-footer">
                                <button type="button" onclick="enviarDireccion()" class="btn btn-primary">Agregar</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div> 

                <span class="fw-normal mb-1 ms-1" style="list-style-type: none; color: #E5E5E5; font-size: 1.1rem;" th:if="${#lists.isEmpty(usuario.Direcciones)}">No hay direcciones</span>

                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Direccion</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="direccion: ${usuario.Direcciones}">
                            <td th:text="|${direccion.Calle}  ${direccion.NumeroExterior}|"></td>
                            <td>
                                <button class="btn btn-warning" th:onclick="|FormDireccionEditable(${direccion.IdDireccion})|">Editar</button>
                                <button id="btnBorrarDireccion" class='btn btn-danger' th:onclick="|confimarEliminarDireccion(${direccion.IdDireccion}, ${usuario.IdUsuario})|">Borrar</button>
                            </td>

                        </tr>
                    </tbody>
                </table>



                <div class="modal fade"  id="modalEditDireccion">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <p>Editar direccion</p>
                            <form method="POST" th:action="@{/UsuarioIndex/updateDireccion/{idUsuario}(idUsuario= ${usuario.IdUsuario})}" id="formEdiDireccion" th:object="${Direccion}">
                                <input id="idDireccion"  type="hidden" th:field="*{IdDireccion}">
                                <input id="idCalle" type="text" th:field="*{Calle}" placeholder="Calle">
                                <input id="idNumeroInterior" type="text" th:field="*{NumeroInterior}" placeholder="NumeroInterior">
                                <input id="idNumeroExterior" type="text" th:field="*{NumeroExterior}" placeholder="NumeroExterior">
                                <input id="idColonia" type="number" th:field="*{Colonia.IdColonia}" placeholder="IdColonia">
                            </form>
                            <div class="modal-footer">
                                <button type="button"  onclick="modificarDireccion()"  class="btn btn-primary">Agregar</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div> 

            </div>
        </div>  

        <script>
            $("#btnEditarInformacion").click(function () {
            $("#modalFormulario").modal("show");
            });
            $("#btnAgregarDireccion").click(function () {
            $("#modalAddDireccion").modal("show");
            });
            $("#btnEditarImagen").click(function (){
            console.log("click");
            $("#modalActualizarImagen").modal("show");
            });
            function FormDireccionEditable(idDireccion) {
            $("#modalEditDireccion").modal("show");
            let direccion;
            $.ajax({
            url: "/UsuarioIndex/DireccionById/" + idDireccion,
                    type: "GET",
                    datatype: "json",
                    success: function (data, textStatus, jqXHR) {
                    direccion = data.object;
                    $("#idDireccion").val(direccion.idDireccion);
                    $("#idCalle").val(direccion.calle);
                    $("#idNumeroInterior").val(direccion.numeroInterior);
                    $("#idNumeroExterior").val(direccion.numeroExterior);
                    $("#idColonia").val(direccion.Colonia.idColonia);
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                    console.error("Error al cargar dirección");
                    }
            });
            }

            function confimarEliminarDireccion(idDireccion, idUsuario) {
            console.log("Eliminando...");
            Swal.fire({
            text: "¿Seguro que quieres eliminar la direccion?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Sí, borrar!"
            }).then((result) => {

            if (result.isConfirmed) {
            console.log("Si");
            $.ajax({
            url: "/UsuarioIndex/deleteDireccion/" + idDireccion + "/" + idUsuario,
                    type: "GET",
                    datatype: "json",
                    success: function (data, textStatus, jqXHR) {
                    if (data.correct) {
                    Swal.fire({
                    title: "Deleted!",
                            text: "Your direccion has been deleted.",
                            icon: "success"
                    });
                    window.location.href = 'http://localhost:8080/UsuarioIndex/usuario-detalles/' + idUsuario;
                    }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                    alert("algo salio mal");
                    }
            });
            }

            });
            }




            function form_submit() {
            document.getElementById("formUpdateUser").submit();
            }

            function enviarDireccion() {
            document.getElementById("formAddDireccion").submit();
            }

            function modificarDireccion() {
            document.getElementById("formEdiDireccion").submit();
            }

            function actualizarImagenSubmit(){
            document.getElementById("formEditImagen").submit();
            }


        </script>


        <script th:if="${msgDireccionAgregada}" th:inline="javascript">
            Swal.fire({
            title: [[${msgDireccionAgregada}
            ]],
                    icon: "success",
                    draggable: true
            });
        </script>

        <script th:if="${msgDireccionEditada}" th:inline="javascript">
            Swal.fire({
            title: [[${msgDireccionEditada}
            ]],
                    icon: "success",
                    draggable: true
            }
            );
        </script>

        <script th:if="${msgUsuarioEditado}" th:inline="javascript">
            Swal.fire({
            title: [[${msgUsuarioEditado}
            ]],
                    icon: "success",
                    draggable: true
            }
            );
        </script>

    </body>
</html>
